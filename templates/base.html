<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}InsuranceGrokBot{% endblock %}</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">Insurance<span class="text-accent">Grok</span>Bot</a>
            <button class="navbar-toggler navbar-dark" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto align-items-center gap-4">
                    <li class="nav-item"><a class="nav-link" href="/#features">Features</a></li>
                    <li class="nav-item"><a class="nav-link" href="/comparison">Comparison</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#pricing">Pricing</a></li>
                    <li class="nav-item"><a class="nav-link" href="/demo-chat">Demo</a></li>
                </ul>
                <div class="d-flex gap-3 mt-3 mt-lg-0">
                    <a href="/login" class="btn btn-outline-accent btn-sm nav-btn">Log In</a>
                    <a href="/register" class="btn btn-primary btn-sm nav-btn">Get Started</a>
                </div>
            </div>
        </div>
    </nav>

    <main>
        {% block content %}
        {% endblock %}
    </main>

    <footer>
        <div class="container">
            <p style="color:#fff; font-weight:700; font-size:1.2rem; margin-bottom:10px;">Insurance<span class="text-accent">Grok</span>Bot</p>
            <div class="mb-4">
                <a href="/terms">Terms</a>
                <a href="/privacy">Privacy</a>
                <a href="/disclaimers">Disclaimers</a>
                <a href="/contact">Contact</a>
            </div>
            <p style="font-size:0.8rem; margin-top:40px; opacity:0.5;">&copy; 2026 InsuranceGrokBot. All rights reserved.</p>
        </div>
    </footer>

    <div class="chat-widget-container">
        
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <div class="bot-identity">
                    <div class="bot-avatar"><i class="fa-solid fa-bolt"></i></div>
                    <div class="bot-info">
                        <h5>Grok Assistant</h5>
                        <div class="bot-status">Online</div>
                    </div>
                </div>
                <button onclick="toggleChat()" style="background:none; border:none; color:#777; cursor:pointer;">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="chat-body" id="chatBody"></div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>

            <div class="chat-footer">
                <input type="text" class="chat-input" id="chatInput" placeholder="Ask anything..." onkeypress="handleEnter(event)">
                <button class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

        <div class="chat-toggle-btn" onclick="toggleChat()">
            <div class="pulse-ring"></div>
            <i class="fa-solid fa-robot"></i>
        </div>
    </div>

    <div id="elite-popup-overlay" class="popup-overlay">
        <div class="popup-card">
            <button class="close-btn" onclick="closePopup()">&times;</button>
            <div class="popup-content">
                <div class="glow-effect"></div>
                <span class="badge">LIMITED OFFER</span>
                <h2>Experience True Intelligence</h2>
                <p>Unlock the full potential of InsuranceGrokBot. Zero limits. Zero cost for the first week.</p>
                <div class="offer-box">
                    <span class="big-text">7 DAYS</span>
                    <span class="sub-text">FREE TRIAL</span>
                </div>
                <a href="/register" class="elite-btn">Start My Free Trial</a>
                <p class="no-commitment">No commitment. Cancel anytime.</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    
<script>
        document.addEventListener("DOMContentLoaded", function() {
            
            // =========================================
            // 1. CAROUSEL LOGIC (Pricing)
            // =========================================
            const cards = document.querySelectorAll('.pricing-card');
            if (cards.length > 0) {
                let activeIndex = 1; 
                let autoRotateInterval;

                window.selectCard = function(index) {
                    if (window.innerWidth < 992) return; 
                    activeIndex = index;
                    updateCarousel();
                    resetTimer(); 
                };

                function updateCarousel() {
                    cards.forEach((card, i) => {
                        card.className = 'pricing-card'; 
                        if (i === activeIndex) {
                            card.classList.add('active');
                        } else if (i === (activeIndex - 1 + 3) % 3) {
                            card.classList.add('prev');
                        } else {
                            card.classList.add('next');
                        }
                    });
                }

                function nextCard() {
                    activeIndex = (activeIndex + 1) % 3;
                    updateCarousel();
                }

                function startTimer() {
                    autoRotateInterval = setInterval(nextCard, 5000); 
                }

                function resetTimer() {
                    clearInterval(autoRotateInterval);
                    startTimer();
                }

                updateCarousel(); 
                startTimer();

                const container = document.querySelector('.carousel-container');
                if (container) {
                    container.addEventListener('mouseenter', () => clearInterval(autoRotateInterval));
                    container.addEventListener('mouseleave', startTimer);
                }
            }

            // =========================================
            // 2. POPUP LOGIC (7-Day Trial)
            // =========================================
            const popup = document.getElementById("elite-popup-overlay");
            const LAST_CLOSED_KEY = "grok_popup_last_closed";
            const COOLDOWN_HOURS = 4;

            function shouldShowPopup() {
                const lastClosed = localStorage.getItem(LAST_CLOSED_KEY);
                if (!lastClosed) return true; 
                const now = new Date().getTime();
                const timePassed = now - parseInt(lastClosed);
                const hoursPassed = timePassed / (1000 * 60 * 60);
                return hoursPassed >= COOLDOWN_HOURS;
            }

            function showPopup() {
                if(popup) {
                    popup.style.display = "flex";
                    setTimeout(() => { popup.classList.add("active"); }, 10);
                }
            }

            window.closePopup = function() {
                if(popup) {
                    popup.classList.remove("active");
                    setTimeout(() => { popup.style.display = "none"; }, 500);
                    localStorage.setItem(LAST_CLOSED_KEY, new Date().getTime().toString());
                }
            };

            if (shouldShowPopup()) {
                setTimeout(showPopup, 2000);
            }

            // =========================================
            // 3. CHAT WIDGET LOGIC (Hybrid Async)
            // =========================================
            const SESSION_KEY = 'grok_chat_session_v1';
            const SESSION_DURATION = 60 * 60 * 1000; // 60 Minutes

            function getOrCreateSession() {
                const now = Date.now();
                const stored = localStorage.getItem(SESSION_KEY);
                
                if (stored) {
                    const data = JSON.parse(stored);
                    if (now - data.timestamp < SESSION_DURATION) {
                        return data.id; // Valid session
                    }
                }
                // Generate NEW Session with 'assist_' prefix
                const newId = 'assist_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem(SESSION_KEY, JSON.stringify({ id: newId, timestamp: now }));
                return newId;
            }

            let chatSessionId = getOrCreateSession();
            const chatWindow = document.getElementById('chatWindow');
            const chatBody = document.getElementById('chatBody');
            const chatInput = document.getElementById('chatInput');
            let isChatOpen = false;
            let hasInitialized = false;

            window.toggleChat = function() {
                isChatOpen = !isChatOpen;
                if (isChatOpen) {
                    chatWindow.classList.add('open');
                    document.getElementById('chatCallout').classList.add('hidden');
                    if (!hasInitialized) {
                        loadHistoryOrInit();
                        hasInitialized = true;
                    }
                    scrollToBottom();
                } else {
                    chatWindow.classList.remove('open');
                    setTimeout(() => document.getElementById('chatCallout').classList.remove('hidden'), 500);
                }
            };

            window.handleEnter = function(e) {
                if (e.key === 'Enter') sendMessage();
            };

            async function loadHistoryOrInit() {
                const res = await fetch(`/get-logs?contact_id=${chatSessionId}`);
                const data = await res.json();
                
                if (data.logs && data.logs.length > 0) {
                    chatBody.innerHTML = '';
                    data.logs.forEach(log => {
                        // Detect role based on log type string
                        const type = (log.type && log.type.includes('Bot')) ? 'bot' : 'user';
                        addMessage(log.content, type);
                    });
                } else {
                    sendSystemMessage("INIT_CHAT");
                }
            }

            window.sendMessage = function(textOverride) {
                const text = textOverride || chatInput.value.trim();
                if (!text) return;

                if (!textOverride) {
                    addMessage(text, 'user');
                    chatInput.value = '';
                }
                
                const loadingId = 'loading-' + Date.now();
                addMessage('...', 'bot', loadingId);

                fetch('/website-bot-webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contact_id: chatSessionId, message: text })
                })
                .then(res => res.json())
                .then(data => {
                    // Scenario A: Instant Reply (Buttons / Redirects)
                    if (data.text || data.redirect || data.options) {
                        const loader = document.getElementById(loadingId);
                        if(loader) loader.remove();

                        if (data.redirect) window.location.href = data.redirect;
                        if (data.text) addMessage(data.text, 'bot');
                        if (data.options) renderButtons(data.options);
                    } 
                    // Scenario B: Async Processing (Worker)
                    else if (data.status === "processing") {
                        // Wait for polling to pick it up.
                        // Failsafe: remove loader if it takes too long
                        setTimeout(() => {
                            const loader = document.getElementById(loadingId);
                            if(loader) loader.remove();
                        }, 15000);
                    }
                })
                .catch(err => {
                    console.error("Chat Error:", err);
                    const loader = document.getElementById(loadingId);
                    if(loader) loader.remove();
                });
            };

            function sendSystemMessage(cmd) {
                fetch('/website-bot-webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contact_id: chatSessionId, message: cmd })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.text) addMessage(data.text, 'bot');
                    if (data.options) renderButtons(data.options);
                });
            }

            function addMessage(text, type, id=null) {
                const div = document.createElement('div');
                div.className = `msg ${type}`;
                div.innerHTML = text;
                if(id) div.id = id;
                chatBody.appendChild(div);
                scrollToBottom();
            }

            function renderButtons(options) {
                const div = document.createElement('div');
                div.style.display = "flex"; div.style.gap = "10px"; div.style.marginTop = "10px";
                
                options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.innerText = opt.label;
                    btn.className = "btn btn-sm btn-outline-accent";
                    btn.style.borderRadius = "20px"; btn.style.fontSize = "0.75rem";
                    btn.onclick = () => {
                        addMessage(opt.label, 'user');
                        sendMessage(opt.value);
                        div.remove();
                    };
                    div.appendChild(btn);
                });
                chatBody.appendChild(div);
                scrollToBottom();
            }

            function scrollToBottom() { chatBody.scrollTop = chatBody.scrollHeight; }
            
            // --- POLLING LOOP (Reads Redis) ---
            setInterval(async () => {
                if (!isChatOpen) return;
                const res = await fetch(`/get-logs?contact_id=${chatSessionId}`);
                const data = await res.json();
                
                const msgs = document.querySelectorAll('.msg');
                const lastMsg = msgs[msgs.length - 1];
                
                if (data.logs && data.logs.length > 0) {
                    const lastLog = data.logs[data.logs.length - 1];
                    const lastLogContent = lastLog.content;
                    
                    // Only add if it's new AND it's a Bot Message
                    if (!lastMsg || (lastMsg.innerText !== lastLogContent && lastLogContent !== '...')) {
                        if (lastLog.type && lastLog.type.includes('Bot')) {
                             // Clean up loading bubbles
                             document.querySelectorAll('[id^="loading-"]').forEach(el => el.remove());
                             addMessage(lastLogContent, 'bot');
                        }
                    }
                }
            }, 3000);
        });
    </script>

    <script>
        AOS.init({ duration: 1000, once: true, offset: 50 });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>