<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}InsuranceGrokBot{% endblock %}</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">Insurance<span class="text-accent">Grok</span>Bot</a>
            <button class="navbar-toggler navbar-dark" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto align-items-center gap-4">
                    <li class="nav-item"><a class="nav-link" href="/#features">Features</a></li>
                    <li class="nav-item"><a class="nav-link" href="/comparison">Comparison</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#pricing">Pricing</a></li>
                    <li class="nav-item"><a class="nav-link" href="/demo-chat">Demo</a></li>
                </ul>
                <div class="d-flex gap-3 mt-3 mt-lg-0">
                    <a href="/login" class="btn btn-outline-accent btn-sm nav-btn">Log In</a>
                    <a href="/register" class="btn btn-primary btn-sm nav-btn">Get Started</a>
                </div>
            </div>
        </div>
    </nav>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer>
        <div class="container">
            <p style="color:#fff; font-weight:700; font-size:1.2rem; margin-bottom:10px;">Insurance<span class="text-accent">Grok</span>Bot</p>
            <div class="mb-4">
                <a href="/terms">Terms</a>
                <a href="/privacy">Privacy</a>
                <a href="/disclaimers">Disclaimers</a>
                <a href="/contact">Contact</a>
            </div>
            <p style="font-size:0.8rem; margin-top:40px; opacity:0.5;">&copy; 2026 InsuranceGrokBot. All rights reserved.</p>
        </div>
    </footer>

    <div class="chat-widget-container">
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <div class="bot-identity">
                    <div class="bot-avatar"><i class="fa-solid fa-bolt"></i></div>
                    <div class="bot-info">
                        <h5>Grok Assistant</h5>
                        <div class="bot-status">Online</div>
                    </div>
                </div>
                <button onclick="toggleChat()" style="background:none; border:none; color:#777; cursor:pointer;">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="chat-body" id="chatBody"></div>

            <div class="typing-indicator" id="typingIndicator" style="display:none;">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>

            <div class="chat-footer">
                <input type="text" class="chat-input" id="chatInput" placeholder="Ask anything..." onkeypress="handleEnter(event)">
                <button class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

        <div class="chat-toggle-btn" onclick="toggleChat()">
            <div class="pulse-ring"></div>
            <i class="fa-solid fa-robot"></i>
        </div>
    </div>

    <div id="elite-popup-overlay" class="popup-overlay">
        <div class="popup-card">
            <button class="close-btn" onclick="closePopup()">&times;</button>
            <div class="popup-content">
                <div class="glow-effect"></div>
                <span class="badge">LIMITED OFFER</span>
                <h2>Experience True Intelligence</h2>
                <p>Unlock the full potential of InsuranceGrokBot. Zero limits. Zero cost for the first week.</p>
                <div class="offer-box">
                    <span class="big-text">7 DAYS</span>
                    <span class="sub-text">FREE TRIAL</span>
                </div>
                <a href="/register" class="elite-btn">Start My Free Trial</a>
                <p class="no-commitment">No commitment. Cancel anytime.</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        AOS.init({ duration: 1000, once: true, offset: 50 });

            // 1. CAROUSEL
            const cards = document.querySelectorAll('.pricing-card');
            if (cards.length > 0) {
                let activeIndex = 1; 
                window.selectCard = function(index) {
                    if (window.innerWidth < 992) return; 
                    activeIndex = index;
                    updateCarousel();
                };
                function updateCarousel() {
                    cards.forEach((card, i) => {
                        card.className = 'pricing-card'; 
                        if (i === activeIndex) card.classList.add('active');
                        else if (i === (activeIndex - 1 + 3) % 3) card.classList.add('prev');
                        else card.classList.add('next');
                    });
                }
                updateCarousel();
                setInterval(() => { activeIndex = (activeIndex + 1) % 3; updateCarousel(); }, 5000);
            }

            // 2. POPUP
            const popup = document.getElementById("elite-popup-overlay");
            if (popup && !localStorage.getItem("grok_popup_last_closed")) {
                setTimeout(() => { 
                    popup.style.display = "flex"; 
                    setTimeout(() => popup.classList.add("active"), 10);
                }, 2000);
            }
            window.closePopup = function() {
                popup.classList.remove("active");
                setTimeout(() => popup.style.display = "none", 500);
                localStorage.setItem("grok_popup_last_closed", Date.now());
            };

           // CHAT WIDGET - FIXED VERSION
            const chatBody = document.getElementById('chatBody');
            const chatWindow = document.getElementById('chatWindow');
            const chatInput = document.getElementById('chatInput');
            const typingIndicator = document.getElementById('typingIndicator');
            
            // Persistent Session ID
            if (!localStorage.getItem('grok_contact_id')) {
                localStorage.setItem('grok_contact_id', 'web_' + Math.random().toString(36).substr(2, 9));
            }
            const chatSessionId = localStorage.getItem('grok_contact_id');

            window.toggleChat = function() {
                chatWindow.classList.toggle('active');
                if (chatWindow.classList.contains('active') && chatBody.innerHTML.trim() === "") {
                    // Start chat on first open
                    appendMessageHTML('assistant', 'Thinking...');
                    sendMessage("INIT_CHAT", true);
                }
            };

            window.handleEnter = (e) => { if (e.key === 'Enter') window.sendMessage(); };

            window.sendMessage = function(textOverride, isSystem = false) {
                const text = textOverride || chatInput.value.trim();
                if (!text) return;

                if (!isSystem) {
                    appendMessageHTML('user', text);
                    chatInput.value = '';
                }

                typingIndicator.style.display = 'flex';  // Show typing

                fetch('/website-bot-webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contact_id: chatSessionId, message: text })
                })
                .then(res => res.json())
                .then(data => {
                    // Handle instant replies (buttons, redirects, text)
                    if (data.text || data.redirect || data.options) {
                        typingIndicator.style.display = 'none';
                        if (data.redirect) {
                            window.location.href = data.redirect;
                        }
                        if (data.text) {
                            appendMessageHTML('assistant', data.text, data.options);
                        }
                    }
                    // For async processing, polling will handle the reply
                })
                .catch(err => {
                    typingIndicator.style.display = 'none';
                    appendMessageHTML('assistant', 'Sorry, something went wrong. Try again!');
                    console.error("Chat Error:", err);
                });
            };

            function appendMessageHTML(role, text, options = null) {
                // Simple de-duplication: don't add if text already exists
                const existingTexts = Array.from(chatBody.querySelectorAll('.msg-content')).map(el => el.innerText.trim());
                if (existingTexts.includes(text.trim())) return;

                const div = document.createElement('div');
                div.className = `msg ${role}`;
                div.innerHTML = `<div class="msg-content p-3" style="border-radius:15px; background:${role==='user'?'var(--accent)':'#222'}; color:#fff; display:inline-block; max-width:80%;">${text}</div>`;
                chatBody.appendChild(div);

                if (options) {
                    const btnWrap = document.createElement('div');
                    btnWrap.className = "d-flex gap-2 flex-wrap mt-2";
                    options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = "btn btn-sm btn-outline-accent";
                        btn.style.borderRadius = "20px";
                        btn.innerText = opt.label;
                        btn.onclick = () => {
                            btnWrap.remove();
                            appendMessageHTML('user', opt.label);
                            window.sendMessage(opt.value, true);
                        };
                        btnWrap.appendChild(btn);
                    });
                    chatBody.appendChild(btnWrap);
                }

                scrollToBottom();
            }

            function scrollToBottom() {
                chatBody.scrollTop = chatBody.scrollHeight;
            }

            // Polling for Async Replies (every 2 seconds when chat is open)
            setInterval(async () => {
                if (!chatWindow.classList.contains('active')) return;
                try {
                    const res = await fetch(`/get-logs?contact_id=${chatSessionId}`);
                    const data = await res.json();
                    if (data.logs && data.logs.length > 0) {
                        // Get the latest log
                        const lastLog = data.logs[data.logs.length - 1];
                        
                        // Only add if it's a bot message
                        if (lastLog.type && lastLog.type.includes('Bot')) {
                            typingIndicator.style.display = 'none';
                            appendMessageHTML('assistant', lastLog.content, lastLog.options);
                        }
                    }
                } catch(e) {
                    console.error("Polling error:", e);
                }
            }, 2000);  // Poll every 2 seconds
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>