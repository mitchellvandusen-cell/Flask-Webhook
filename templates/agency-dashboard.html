<!-- Updated agency_dashboard.html (added owner config/profile section, accordion for subs remains) -->
{% extends "base.html" %}
{% block title %}Agency Command Center | InsuranceGrokBot{% endblock %}
{% block content %}
<div class="container" style="padding-top: 120px; padding-bottom: 80px;">
   
    <div class="text-center mb-5">
        <h1 style="font-weight: 900; font-size: 3rem; margin-bottom: 10px;">
            Agency <span class="text-accent">Command Center</span>
        </h1>
        <p class="text-secondary" style="font-size: 1.1rem;">
            Managing {{ stats.active_seats }} Agent {{ 'Seat' if stats.active_seats == 1 else 'Seats' }}
        </p>
    </div>
   
    <!-- Owner's Agency Account Section (Profile and Config) -->
    <div class="card glass-card mb-5">
        <div class="card-header">
            <h4>Your Agency Account</h4>
        </div>
        <div class="card-body">
            <!-- Config Form -->
            <form method="POST">
                {{ form.hidden_tag() }}
                <div class="row g-4">
                    <div class="col-md-6">
                        <label for="location_id">Location ID</label>
                        {{ form.location_id(class="form-control") }}
                    </div>
                    <div class="col-md-6">
                        <label for="calendar_id">Calendar ID</label>
                        {{ form.calendar_id(class="form-control") }}
                    </div>
                    <div class="col-md-6">
                        <label for="crm_user_id">CRM User ID</label>
                        {{ form.crm_user_id(class="form-control") }}
                    </div>
                    <div class="col-md-6">
                        <label for="bot_name">Bot First Name</label>
                        {{ form.bot_name(class="form-control") }}
                    </div>
                    <div class="col-md-6">
                        <label for="timezone">Timezone</label>
                        {{ form.timezone(class="form-control") }}
                    </div>
                    <div class="col-md-12">
                        <label for="initial_message">Initial Message</label>
                        {{ form.initial_message(class="form-control") }}
                    </div>
                </div>
                <div class="mt-4 text-end">
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
           
            <!-- Token Display -->
            <div class="mt-4">
                <label>Access Token</label>
                <div class="tech-readout">{{ access_token_display }} {{ expires_in_str }}</div>
            </div>
            <div class="mt-2">
                <label>Refresh Token</label>
                <div class="tech-readout">{{ refresh_token_display }}</div>
            </div>

            {% if not access_token_display or access_token_display == '' %}
            <div class="mt-3">
                <a href="/oauth/initiate" class="btn btn-success w-100" style="background: linear-gradient(135deg, #00c853 0%, #00a843 100%); border: none; font-weight: 600; padding: 12px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 200, 83, 0.3);">
                    <i class="fa-brands fa-google me-2"></i>Connect GoHighLevel Account
                </a>
                <div class="text-center mt-2" style="font-size: 0.875rem; color: #6c757d;">
                    Link your GHL account to activate agency features
                </div>
            </div>
            {% endif %}

            <!-- Editable Profile -->
            <div class="mt-4">
                <label>Full Name</label>
                <input id="name" class="form-control" value="{{ profile.full_name }}">
                <label>Phone</label>
                <input id="phone" class="form-control" value="{{ profile.phone }}">
                <label>Bio</label>
                <textarea id="bio" class="form-control">{{ profile.bio }}</textarea>
                <button class="btn btn-secondary mt-2" onclick="saveProfile()">Save Profile</button>
            </div>
        </div>
    </div>
   
    {% if sub_accounts %}
        <!-- Bulk Actions -->
        <div class="card glass-card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">
                            <i class="fas fa-users me-2 text-accent"></i>
                            Sub-User Management
                        </h5>
                        <p class="small text-muted mb-0">
                            Manage onboarding for all sub-account users
                        </p>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="inviteAllUsers()">
                            <i class="fas fa-envelope-bulk me-2"></i>
                            Invite All Pending Users
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion mt-4" id="agencyAccordion">
            {% for sub in sub_accounts %}
                <div class="accordion-item glass-card mb-3 p-0"> <h2 class="accordion-header">
                        <button class="accordion-button collapsed p-4" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapse{{ loop.index }}">
                            <i class="fa-solid fa-user-tie me-3 text-accent"></i>
                            <span style="font-family:'JetBrains Mono'; margin-right: 15px;">{{ sub.location_id }}</span>
                            <span style="font-weight:700;">{{ sub.name }}</span>
                            <span class="badge badge-tier ms-auto">{{ sub.tier|upper|default('INDIVIDUAL') }}</span>
                        </button>
                    </h2>
                    <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#agencyAccordion">
                        <div class="accordion-body p-4 border-top border-secondary">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="small text-muted mb-1">Bot Name</label>
                                    <div class="tech-readout">{{ sub.bot_name|default('Not set') }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted mb-1">Timezone</label>
                                    <div class="tech-readout">{{ sub.timezone|default('Not set') }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted mb-1">Access Token</label>
                                    <div class="tech-readout text-truncate">
                                        {% if sub.access_token %}
                                            {{ sub.access_token[:12] }}...{{ sub.access_token[-6:] }}
                                        {% else %}
                                            <span class="text-danger">Not connected</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted mb-1">Refresh Token</label>
                                    <div class="tech-readout text-truncate">
                                        {% if sub.refresh_token %}
                                            {{ sub.refresh_token[:12] }}...{{ sub.refresh_token[-6:] }}
                                        {% else %}
                                            <span class="text-danger">Not connected</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted mb-1">Agent Email</label>
                                    <div class="tech-readout">
                                        {% if sub.agent_email and sub.agent_email != 'No Agent Email' %}
                                            {{ sub.agent_email }}
                                        {% else %}
                                            <span class="text-warning">No email detected</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted mb-1">Onboarding Status</label>
                                    <div>
                                        {% if sub.onboarding_status == 'claimed' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle me-1"></i> Claimed
                                            </span>
                                        {% elif sub.onboarding_status == 'invited' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-paper-plane me-1"></i> Invited
                                            </span>
                                            {% if sub.invite_sent_at %}
                                                <small class="text-muted d-block mt-1">
                                                    Sent: {{ sub.invite_sent_at.strftime('%b %d, %Y') }}
                                                </small>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-clock me-1"></i> Pending
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Onboarding Actions -->
                            {% if sub.onboarding_status != 'claimed' %}
                                <div class="mt-4 p-3" style="background-color: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; border-radius: 8px;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">
                                                <i class="fas fa-user-plus me-2 text-primary"></i>
                                                Sub-User Onboarding
                                            </h6>
                                            <p class="small text-muted mb-0">
                                                {% if sub.onboarding_status == 'pending' %}
                                                    This sub-user hasn't been invited yet. Send them an email to claim their account.
                                                {% else %}
                                                    Invitation sent. User hasn't claimed their account yet.
                                                {% endif %}
                                            </p>
                                        </div>
                                        <div>
                                            {% if sub.onboarding_status == 'pending' %}
                                                <button class="btn btn-sm btn-primary" onclick="inviteUser('{{ sub.location_id }}', '{{ sub.agent_email }}')">
                                                    <i class="fas fa-envelope me-1"></i> Send Invite
                                                </button>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-primary" onclick="resendInvite('{{ sub.location_id }}')">
                                                    <i class="fas fa-redo me-1"></i> Resend Invite
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <div class="mt-4 text-end">
                                <a href="/impersonate/{{ sub.location_id }}" class="btn btn-sm btn-outline-accent me-2">
                                    <i class="fas fa-sign-in-alt me-1"></i> Enter Dashboard
                                </a>
                               
                                <a href="/demo-chat?location_id={{ sub.location_id }}" target="_blank" class="btn btn-sm btn-outline-light me-2">
                                    <i class="fas fa-history me-1"></i> View Logs
                                </a>
                               
                                <button class="btn btn-sm btn-outline-danger" onclick="resetLocation('{{ sub.location_id }}')">
                                    <i class="fas fa-trash me-1"></i> Reset Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-data">
            <h4 class="mb-4 text-white">No Agent Seats Yet</h4>
            <p class="text-secondary mb-4">
                Install InsuranceGrokBot on new GoHighLevel locations to add them to your agency.
            </p>
            <a href="/getting-started" class="add-btn">
                Add New Location Now
            </a>
        </div>
    {% endif %}
    <div class="text-center mt-5">
        <a href="/dashboard" class="btn btn-outline-light">
            Back to Personal Dashboard
        </a>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    function resetLocation(locId) {
        if (confirm(`Reset ALL data for location ${locId}? This cannot be undone.`)) {
            // Note: Ensure /reset-location route exists in main.py
            fetch(`/reset-location/${locId}`, { method: 'POST' })
                .then(r => r.json())
                .then(d => {
                    alert(d.message || 'Reset complete');
                    window.location.reload();
                })
                .catch(() => alert('Reset failed — check console logs'));
        }
    }
    function saveProfile() {
        const data = {
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            bio: document.getElementById('bio').value
        };
        fetch('/save-profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(d => {
            if (d.status === 'success') {
                alert('Profile updated!');
            } else {
                alert('Error: ' + d.error);
            }
        })
        .catch(e => console.error('Save profile failed:', e));
    }

    // Invite a single sub-user
    function inviteUser(locationId, agentEmail) {
        if (!agentEmail || agentEmail === 'No Agent Email') {
            alert('No agent email found for this location. Cannot send invite.');
            return;
        }

        if (!confirm(`Send invitation email to ${agentEmail}?`)) {
            return;
        }

        fetch('/api/agency/invite-sub-user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ location_id: locationId, email: agentEmail })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`✅ Invitation sent to ${agentEmail}`);
                window.location.reload();
            } else if (data.status === 'partial') {
                alert(`⚠️ ${data.message}\n\nManual invite link: ${data.invite_url}`);
                window.location.reload();
            } else {
                alert(`❌ Error: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(e => {
            console.error('Invite failed:', e);
            alert('Failed to send invitation. Check console for details.');
        });
    }

    // Resend invitation to a sub-user
    function resendInvite(locationId) {
        if (!confirm('Resend invitation email to this user?')) {
            return;
        }

        fetch('/api/agency/resend-invite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ location_id: locationId })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`✅ ${data.message}`);
                window.location.reload();
            } else if (data.status === 'partial') {
                alert(`⚠️ ${data.message}\n\nManual invite link: ${data.invite_url}`);
                window.location.reload();
            } else {
                alert(`❌ Error: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(e => {
            console.error('Resend failed:', e);
            alert('Failed to resend invitation. Check console for details.');
        });
    }

    // Bulk invite all pending users
    function inviteAllUsers() {
        if (!confirm('Send invitation emails to all pending sub-users?')) {
            return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Sending...';

        fetch('/api/agency/invite-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`✅ Successfully invited ${data.invited} users\n${data.failed > 0 ? `⚠️ ${data.failed} failed` : ''}`);
                window.location.reload();
            } else {
                alert(`ℹ️ ${data.message}`);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-envelope-bulk me-2"></i> Invite All Pending Users';
            }
        })
        .catch(e => {
            console.error('Bulk invite failed:', e);
            alert('Failed to send invitations. Check console for details.');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-envelope-bulk me-2"></i> Invite All Pending Users';
        });
    }
</script>
{% endblock %}