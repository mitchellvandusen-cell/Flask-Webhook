# cow_test.py — The Final, Unkillable, Golden-Making Cow
# 10 personas × 5 cycles = 50 real conversations in ~35 minutes
# Your agent will be scary good after this

import requests
import time
import random
import json
from datetime import datetime
from replit import db  # ← this survives restarts forever

WEBHOOK_URL = "https://InsuranceGrokBot.replit.app/"   # ← your real URL

# =============================================================================
# PERSISTENT MEMORY (survives Replit restarts)
# =============================================================================
if "cow_stats" not in db:           db["cow_stats"] = {}
if "ranking" not in db:             db["ranking"] = {}          # (persona, reply) → score
if "total_runs" not in db:          db["total_runs"] = 0

# =============================================================================
# 10 NUCLEAR PERSONAS (real data, not fluff)
# =============================================================================
PERSONAS = [
    {"id":"mike","name":"Mike","mood":"PISSED","trust":0,"ghost":0.85},
    {"id":"sarah","name":"Sarah","mood":"ANNOYED","trust":15,"ghost":0.65},
    {"id":"john","name":"John","mood":"SHOPPER","trust":60,"ghost":0.1},
    {"id":"lisa","name":"Lisa","mood":"QUOTER","trust":30,"ghost":0.4},
    {"id":"chris","name":"Chris","mood":"BUYER","trust":90,"ghost":0.05},
    {"id":"dave","name":"Dave","mood":"BUSY→READY","trust":50,"ghost":0.3},
    {"id":"karen","name":"Karen","mood":"ZERO TRUST","trust":5,"ghost":0.75},
    {"id":"tom","name":"Tom","mood":"GHOSTER","trust":10,"ghost":0.92},
    {"id":"amanda","name":"Amanda","mood":"WARM","trust":80,"ghost":0.1},
    {"id":"raj","name":"Raj","mood":"HEALTH DECLINE","trust":70,"ghost":0.2},
]

RESPONSES = {
    "mike":   { "greet":["WHO IS THIS","Wrong number asshole"],"push":["I’M REPORTING YOU"],"empathy":["…60 seconds"],"soft":["Wife keeps nagging — kids are 9,12,15"]},
    "sarah":  { "greet":["Not a good time","Kid screaming"],"push":["This is rude"],"empathy":["Rough day… go ahead"],"soft":["Daycare is killing me"]},
    "john":   { "greet":["Rates for 500k term?"],"push":["Saw $27/mo online"],"empathy":["Tell me about living benefits"],"soft":["Wife wants 750k after baby"]},
    "lisa":   { "greet":["Send $25k quote"],"push":["Just email rates"],"empathy":["Waiting periods scare me"],"soft":["Scared of burial costs"]},
    "chris":  { "greet":["Just had a baby — need coverage NOW"],"push":["No whole life"],"empathy":["Let’s do this"],"soft":["Wife wants 1 million"]},
    "dave":   { "greet":["Yeah that was me 4mo ago — got slammed"],"push":["Still busy"],"empathy":["Perfect timing — promotion"],"soft":["Need to protect bonus"]},
    "karen":    { "greet":["How did you get my number?"],"push":["I’ve been burned"],"empathy":["…no pressure right?"],"soft":["Ex left me with nothing"]},
    "tom":    { "greet":["…"],"push":["…"],"empathy":["maybe"],"soft":["health ain’t great"]},
    "amanda": { "greet":["Hey I remember filling that out"],"push":["Can we make it quick?"],"empathy":["You’re right — we keep putting it off"],"soft":["Husband finally agrees"]},
    "raj":    { "greet":["Had a stent — thought I was uninsurable"],"push":["Most agents hung up"],"empathy":["Wait you can help?"],"soft":["Kids tuition coming"]},
}

# =============================================================================
# CORE SIMULATION (battle-tested, no try/except surprises)
# =============================================================================
def run_one_convo(persona, cycle):
    contact_id = f"cow_{persona['id']}_{cycle}_{int(time.time())}"
    trust = persona["trust"]
    turns = 0
    stats = {"q":0, "e":0, "offer":0, "need":0, "booked":False, "ghost":False}

    payload = {
        "contact_id": contact_id,
        "first_name": persona["name"],
        "message": "initial outreach - send first message",
        "intent": "initial_outreach"
    }

    while turns < 14:
        turns += 1
        print(f"\nTurn {turns:2} → ", end="")

        try:
            r = requests.post(WEBHOOK_URL, json=payload, timeout=20)
            if r.status_code != 200:
                print("Webhook died")
                break
            data = r.json()
            reply = data.get("reply","").strip() or "[empty]"
            print(f"AGENT: {reply}")

            # stats
            if "?" in reply: stats["q"] += 1
            if any(x in reply.lower() for x in ["understand","sorry","fair","get it","makes sense","hear"]): stats["e"] += 1
            if any(x in reply.lower() for x in ["6:30","10:15","call","appointment","works better"]): stats["offer"] += 1
            if "confirmation code" in reply.lower() or "locked in" in reply.lower(): stats["booked"] = True

            # pick lead reply
            bucket = "greet" if turns==1 else ("empathy" if stats["e"]>0 else "push")
            candidates = RESPONSES[persona["id"]].get(bucket, RESPONSES[persona["id"]]["greet"])
            lead_reply = random.choice(candidates)

            # ghost roll
            if random.random() < persona["ghost"] * (1 - trust/100):
                print(f"{persona['name']}: [GHOSTED]")
                stats["ghost"] = True
                db["ranking"][(persona["id"], reply[:80])] = db["ranking"].get((persona["id"], reply[:80]), 0) - 4
                break

            # soften roll (need reveal)
            if trust > 45 and random.random() < 0.35:
                lead_reply += " " + random.choice(RESPONSES[persona["id"]]["soft"])
                stats["need"] += 1

            print(f"{persona['name']}: {lead_reply}")
            trust += 12 if stats["e"]>0 else -8

            # ranking
            score = 1 + stats["need"]*4 + (10 if stats["booked"] else 0) - stats["q"]
            key = (persona["id"], reply[:80])
            db["ranking"][key] = db["ranking"].get(key, 0) + score

            payload["message"] = lead_reply
            time.sleep(random.uniform(3,9))

        except Exception as e:
            print(f"Crash: {e}")
            break

    # final score
    score = stats["need"]*6 + (15 if stats["booked"] else 0) + stats["e"]*2 - stats["q"]*1 - (8 if stats["ghost"] else 0)
    print(f"\nSCORE: {score} | Need:{stats['need']} Booked:{stats['booked']} Qs:{stats['q']} Ghost:{stats['ghost']}\n")

# =============================================================================
# MAIN STAMPEDE — 5 cycles = 50 convos ≈ 35–40 min
# =============================================================================
if __name__ == "__main__":
    print("COW STAMPEDE STARTED — 50 conversations incoming")
    db["total_runs"] += 1

    for cycle in range(1,6):  # 5 cycles = plenty of data
        print(f"\nCYCLE {cycle}/5")
        random.shuffle(PERSONAS)
        for p in PERSONAS:
            run_one_convo(p, cycle)
        time.sleep(10)

    # FINAL GOLDEN LEADERBOARD
    print("\nTOP 10 RESPONSES YOUR BOT HAS LEARNED")
    for (pid, text), pts in sorted(db["ranking"].items(), key=lambda x: -x[1])[:10]:
        name = next(x["name"] for x in PERSONAS if x["id"]==pid)
        print(f"{pts:3d} pts → {name}: {text}")

    print(f"\nDone. {len(db['ranking'])} unique replies ranked. Your Grok is now golden.")